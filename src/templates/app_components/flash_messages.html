{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div id="flash-container" class="flash-container">
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}" data-duration="5000">
                    <div class="flash-content">
                        <span class="flash-icon">
                            {% if category == 'success' %}✓
                            {% elif category == 'error' %}✕
                            {% elif category == 'warning' %}⚠
                            {% else %}ℹ
                            {% endif %}
                        </span>
                        <span class="flash-text">{{ message }}</span>
                        <button class="flash-close" onclick="closeFlash(this.parentElement.parentElement)">&times;</button>
                    </div>
                    <div class="flash-timer"></div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<style>
.flash-container {
    position: fixed;
    top: 2rem;
    right: 2rem;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 400px;
    pointer-events: none;
}

.flash-message {
    pointer-events: auto;
    background: var(--bg-secondary);
    border: var(--border-md) solid;
    box-shadow: var(--shadow-xl) var(--shadow-xl) 0;
    overflow: hidden;
    animation: slideIn 0.3s ease-out;
    position: relative;
}

.flash-message.flash-success {
    border-color: var(--success-primary);
    box-shadow: var(--shadow-xl) var(--shadow-xl) 0 var(--success-dark);
}

.flash-message.flash-error {
    border-color: var(--danger-primary);
    box-shadow: var(--shadow-xl) var(--shadow-xl) 0 var(--danger-dark);
}

.flash-message.flash-warning {
    border-color: var(--coin-primary);
    box-shadow: var(--shadow-xl) var(--shadow-xl) 0 var(--coin-dark);
}

.flash-message.flash-info {
    border-color: var(--accent-primary);
    box-shadow: var(--shadow-xl) var(--shadow-xl) 0 var(--accent-dark);
}

.flash-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
}

.flash-icon {
    font-size: 1.5rem;
    font-weight: 900;
    flex-shrink: 0;
}

.flash-success .flash-icon {
    color: var(--success-primary);
}

.flash-error .flash-icon {
    color: var(--danger-primary);
}

.flash-warning .flash-icon {
    color: var(--coin-primary);
}

.flash-info .flash-icon {
    color: var(--accent-primary);
}

.flash-text {
    flex: 1;
    font-weight: 700;
    font-size: 0.9375rem;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.flash-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    color: var(--text-secondary);
    font-weight: 800;
    padding: 0;
    margin-left: 0.5rem;
    transition: color 0.2s;
    flex-shrink: 0;
}

.flash-close:hover {
    color: var(--text-primary);
}

.flash-timer {
    height: 4px;
    width: 100%;
    position: relative;
    overflow: hidden;
}

.flash-timer::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    transform-origin: left;
    animation: timerProgress var(--timer-duration, 5s) linear forwards;
}

.flash-success .flash-timer::before {
    background: var(--success-primary);
}

.flash-error .flash-timer::before {
    background: var(--danger-primary);
}

.flash-warning .flash-timer::before {
    background: var(--coin-primary);
}

.flash-info .flash-timer::before {
    background: var(--accent-primary);
}

.flash-message.paused .flash-timer::before {
    animation-play-state: paused;
}

.flash-message.closing {
    animation: slideOut 0.3s ease-out forwards;
}

@keyframes slideIn {
    from {
        transform: translateX(calc(100% + 2rem));
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(calc(100% + 2rem));
        opacity: 0;
    }
}

@keyframes timerProgress {
    from {
        transform: scaleX(1);
    }
    to {
        transform: scaleX(0);
    }
}

@media (max-width: 768px) {
    .flash-container {
        top: 1rem;
        right: 1rem;
        left: 1rem;
        max-width: none;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const flashMessages = document.querySelectorAll('.flash-message');
    
    flashMessages.forEach(function(flash) {
        const duration = parseInt(flash.dataset.duration) || 5000;
        flash.style.setProperty('--timer-duration', duration + 'ms');
        
        let timeoutId;
        let remainingTime = duration;
        let startTime = Date.now();
        let isPaused = false;
        
        function startTimer() {
            startTime = Date.now();
            timeoutId = setTimeout(function() {
                closeFlash(flash);
            }, remainingTime);
        }
        
        function pauseTimer() {
            if (!isPaused) {
                clearTimeout(timeoutId);
                remainingTime -= Date.now() - startTime;
                flash.classList.add('paused');
                isPaused = true;
            }
        }
        
        function resumeTimer() {
            if (isPaused) {
                flash.classList.remove('paused');
                isPaused = false;
                startTimer();
            }
        }
        
        flash.addEventListener('mouseenter', pauseTimer);
        flash.addEventListener('mouseleave', resumeTimer);
        
        // Start the initial timer
        startTimer();
    });
});

function closeFlash(flashElement) {
    flashElement.classList.add('closing');
    setTimeout(function() {
        flashElement.remove();
        
        // Check if container is empty and remove it
        const container = document.getElementById('flash-container');
        if (container && container.children.length === 0) {
            container.remove();
        }
    }, 300);
}
</script>