{% extends "bases/private.html" %}

{% block title %}Manage Chores - Stewardwell{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Manage Chores</h1>
        <p>Create and assign family tasks</p>
    </div>

    {% include 'private/parents/components/navbar.html' %}

    <div class="dashboard-grid">
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>All Chores</h2>
                <button onclick="toggleModal('createChoreModal')">+ Create Chore</button>
            </div>
            <div class="card-body">
                {% if chores %}
                <!-- Tag Filter -->
                <div id="tagFilterSection" style="margin-bottom: var(--space-lg); display: none;">
                    <div style="display: flex; align-items: center; gap: var(--space-sm); flex-wrap: wrap;">
                        <strong style="color: var(--text-primary);">Filter by tag:</strong>
                        <button class="tag-filter-btn active" data-tag="all" onclick="filterByTag('all')"
                            style="padding: 0.375rem 0.75rem; background: var(--accent-primary); color: white; border: var(--border-sm) solid var(--accent-dark); font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 0.8125rem; box-shadow: var(--shadow-sm) var(--shadow-sm) 0 var(--accent-dark); transition: all 0.2s;">
                            All
                        </button>
                        <div id="tagFilters" style="display: flex; gap: var(--space-sm); flex-wrap: wrap;"></div>
                    </div>
                </div>
                <div class="row g-3">
                    {% for chore in chores %}
                    <div class="col-12 col-md-6 col-lg-4">
                        {% include 'private/parents/chores/components/chore_item.html' %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state text-center">
                    <p style="font-size: 1.1rem; color: var(--text-muted, #666);">No chores created yet</p>
                    <button class="btn-primary" onclick="toggleModal('createChoreModal')" style="margin-top: 1.5rem;">
                        + Create First Chore
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Chore Modal -->
<div id="createChoreModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Chore</h3>
            <span class="close" onclick="toggleModal('createChoreModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('parent.create_chore') }}">
            <div class="form-group mb-3">
                <label for="chore_name">Chore Name</label>
                <input type="text" id="chore_name" name="name" required placeholder="e.g., Clean room">
            </div>
            <div class="form-group mb-3">
                <label for="chore_description">Description (Optional)</label>
                <textarea id="chore_description" name="description" rows="3"
                    placeholder="Add details about what needs to be done..."
                    style="resize: vertical; min-height: 4rem;"></textarea>
            </div>
            <div class="form-group mb-3">
                <label for="chore_tags">Tags (Optional)</label>
                <input type="text" id="chore_tags" name="tags" placeholder="e.g., cleaning, outdoor, weekly">
                <small class="help-text">Separate multiple tags with commas</small>
            </div>
            <div class="form-group mb-3">
                <label for="coin_value">Coin Value</label>
                <input type="number" id="coin_value" name="coin_value" min="0" value="10" required>
            </div>
            <div class="form-group mb-3">
                <label for="point_value">Point Value</label>
                <input type="number" id="point_value" name="point_value" min="0" value="1" required>
            </div>
            <div class="form-group mb-3">
                <label for="frequency">Frequency</label>
                <select id="frequency" name="frequency" required>
                    <option value="unlimited">Unlimited (anytime)</option>
                    <option value="daily">Daily (once per day)</option>
                    <option value="weekly">Weekly (once per week)</option>
                    <option value="monthly">Monthly (once per month)</option>
                    <option value="one_time">One Time Only</option>
                </select>
                <small class="help-text">How often can this chore be done?</small>
            </div>
            <div class="form-group mb-3">
                <label
                    style="display: flex; align-items: center; gap: var(--space-sm); text-transform: none; cursor: pointer;">
                    <input type="checkbox" id="is_active" name="is_active" checked
                        style="width: auto; cursor: pointer;">
                    <span>Active (visible to kids)</span>
                </label>
                <small class="help-text">Uncheck to hide this chore from kids</small>
            </div>
            <div class="modal-footer d-flex flex-wrap gap-2 justify-content-end">
                <button type="button" class="btn-secondary" onclick="toggleModal('createChoreModal')">Cancel</button>
                <button type="submit" class="btn-primary">Create Chore</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Chore Modal -->
<div id="editChoreModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Chore</h3>
            <span class="close" onclick="toggleModal('editChoreModal')">&times;</span>
        </div>
        <form id="editChoreForm" method="POST">
            <div class="form-group mb-3">
                <label for="edit_chore_name">Chore Name</label>
                <input type="text" id="edit_chore_name" name="name" required placeholder="e.g., Clean room">
            </div>
            <div class="form-group mb-3">
                <label for="edit_chore_description">Description (Optional)</label>
                <textarea id="edit_chore_description" name="description" rows="3"
                    placeholder="Add details about what needs to be done..."
                    style="resize: vertical; min-height: 4rem;"></textarea>
            </div>
            <div class="form-group mb-3">
                <label for="edit_chore_tags">Tags (Optional)</label>
                <input type="text" id="edit_chore_tags" name="tags" placeholder="e.g., cleaning, outdoor, weekly">
                <small class="help-text">Separate multiple tags with commas</small>
            </div>
            <div class="form-group mb-3">
                <label for="edit_coin_value">Coin Value</label>
                <input type="number" id="edit_coin_value" name="coin_value" min="0" required>
            </div>
            <div class="form-group mb-3">
                <label for="edit_point_value">Point Value</label>
                <input type="number" id="edit_point_value" name="point_value" min="0" required>
            </div>
            <div class="form-group mb-3">
                <label for="edit_frequency">Frequency</label>
                <select id="edit_frequency" name="frequency" required>
                    <option value="unlimited">Unlimited (anytime)</option>
                    <option value="daily">Daily (once per day)</option>
                    <option value="weekly">Weekly (once per week)</option>
                    <option value="monthly">Monthly (once per month)</option>
                    <option value="one_time">One Time Only</option>
                </select>
                <small class="help-text">How often can this chore be done?</small>
            </div>
            <div class="form-group mb-3">
                <label
                    style="display: flex; align-items: center; gap: var(--space-sm); text-transform: none; cursor: pointer;">
                    <input type="checkbox" id="edit_is_active" name="is_active" style="width: auto; cursor: pointer;">
                    <span>Active (visible to kids)</span>
                </label>
                <small class="help-text">Uncheck to hide this chore from kids</small>
            </div>
            <div class="modal-footer d-flex flex-wrap gap-2 justify-content-end">
                <button type="button" class="btn-secondary" onclick="toggleModal('editChoreModal')">Cancel</button>
                <button type="submit" class="btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/api.js') }}"></script>
<script>
    function toggleModal(modalId) {
        document.getElementById(modalId).classList.toggle('active');
    }

    // Edit chore buttons - use event delegation
    document.addEventListener('DOMContentLoaded', function () {
        // Setup AJAX for create chore form
        setupAjaxForm('#createChoreModal form', {
            closeModal: 'createChoreModal',
            onSuccess: () => {
                location.reload();
            }
        });
        
        // Setup AJAX for edit chore form
        setupAjaxForm('#editChoreForm', {
            closeModal: 'editChoreModal',
            onSuccess: () => {
                location.reload();
            }
        });
        
        // Handle toggle chore forms (in cards and modals)
        document.querySelectorAll('form[action*="toggle-chore"]').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                await submitForm(form, {
                    onSuccess: (data) => {
                        // Update the button text
                        const button = form.querySelector('button[type="submit"]');
                        if (button) {
                            button.textContent = data.is_active ? 'âœ“ Active' : 'ðŸ‘ï¸ Hidden';
                            button.className = `status-badge ${data.is_active ? 'active' : 'inactive'}`;
                            button.title = `Click to ${data.is_active ? 'hide' : 'show'}`;
                        }
                    }
                });
            });
        });
        
        // Handle delete buttons
        document.querySelectorAll('.delete-chore-btn').forEach(function (btn) {
            btn.addEventListener('click', async function () {
                const choreId = this.dataset.choreId;
                const choreName = this.dataset.choreName;
                if (confirm('Delete ' + choreName + '? This cannot be undone.')) {
                    const form = document.getElementById('delete-form-' + choreId);
                    await submitForm(form, {
                        onSuccess: () => {
                            // Remove the chore card
                            const choreCard = form.closest('.col-12, .col-md-6');
                            if (choreCard) {
                                removeElement(choreCard);
                            }
                        }
                    });
                }
            });
        });
        
        // Handle edit buttons
        document.querySelectorAll('.edit-chore-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const choreId = this.dataset.choreId;
                const name = this.dataset.choreName;
                const description = this.dataset.choreDescription;
                const tags = this.dataset.choreTags;
                const coinValue = this.dataset.choreCoin;
                const pointValue = this.dataset.chorePoint;
                const frequency = this.dataset.choreFrequency;
                const isActive = this.dataset.choreActive === 'true';

                // Set form action
                document.getElementById('editChoreForm').action = '/parent/edit-chore/' + choreId;

                // Populate form fields
                document.getElementById('edit_chore_name').value = name;
                document.getElementById('edit_chore_description').value = description || '';
                document.getElementById('edit_chore_tags').value = tags || '';
                document.getElementById('edit_coin_value').value = coinValue;
                document.getElementById('edit_point_value').value = pointValue;
                document.getElementById('edit_frequency').value = frequency;
                document.getElementById('edit_is_active').checked = isActive;

                // Open modal
                toggleModal('editChoreModal');
            });
        });

        // Handle view details buttons
        document.querySelectorAll('.view-chore-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const choreId = this.dataset.choreId;
                toggleModal('choreDetailsModal-' + choreId);
            });
        });

        // Tag filtering system
        const allTags = new Set();

        // Collect all unique tags from chores
        document.querySelectorAll('.chore-item').forEach(function (item) {
            const tags = item.dataset.choreTags;
            if (tags) {
                tags.split(',').forEach(function (tag) {
                    const trimmed = tag.trim();
                    if (trimmed) {
                        allTags.add(trimmed);
                    }
                });
            }
        });

        // Populate filter buttons if tags exist
        if (allTags.size > 0) {
            const tagFilters = document.getElementById('tagFilters');
            allTags.forEach(function (tag) {
                const btn = document.createElement('button');
                btn.className = 'tag-filter-btn';
                btn.dataset.tag = tag;
                btn.textContent = '#' + tag;
                btn.style.cssText = 'padding: 0.375rem 0.75rem; background: var(--bg-light); color: var(--text-primary); border: var(--border-sm) solid var(--accent-dark); font-weight: 700; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease;';
                btn.onclick = function () { filterByTag(tag); };
                tagFilters.appendChild(btn);
            });

            // Show filter section
            document.getElementById('tagFilterSection').style.display = 'block';
        }

        // Filter function
        window.filterByTag = function (tag) {
            document.querySelectorAll('.chore-item').forEach(function (item) {
                const tags = item.dataset.choreTags;
                const col = item.closest('.col-12, .col-md-6');

                if (tag === 'all') {
                    col.style.display = 'block';
                } else if (tags && tags.split(',').some(function (t) { return t.trim() === tag; })) {
                    col.style.display = 'block';
                } else {
                    col.style.display = 'none';
                }
            });

            // Update active button styling
            document.querySelectorAll('.tag-filter-btn').forEach(function (btn) {
                if (btn.dataset.tag === tag) {
                    btn.classList.add('active');
                    btn.style.background = 'var(--accent-primary)';
                    btn.style.color = 'white';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'var(--bg-light)';
                    btn.style.color = 'var(--text-primary)';
                }
            });
        };
    });
</script>
{% endblock %}