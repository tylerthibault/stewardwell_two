{% extends "bases/private.html" %}

{% block title %}Manage Chores - Stewardwell{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Manage Chores</h1>
        <p>Create and assign family tasks</p>
    </div>

    {% include 'private/parents/components/navbar.html' %}

    <!-- Tabs (Desktop) -->
    <ul class="my-tabs">
        <li class="my-tab-item">
            <a href="#setup-tab" class="my-tab-link active" data-my-target="#setup-tab">Setup Chores</a>
        </li>
        <li class="my-tab-item">
            <a href="#active-tab" class="my-tab-link" data-my-target="#active-tab">Active Chores ({{ active_assignments|length }})</a>
        </li>
        <li class="my-tab-item">
            <a href="#pending-tab" class="my-tab-link" data-my-target="#pending-tab">Pending Approval ({{ pending_assignments|length }})</a>
        </li>
    </ul>

    <!-- Dropdown (Mobile) -->
    <div class="my-tabs-dropdown">
        <select>
            <option value="#setup-tab">Setup Chores</option>
            <option value="#active-tab">Active Chores ({{ active_assignments|length }})</option>
            <option value="#pending-tab">Pending Approval ({{ pending_assignments|length }})</option>
        </select>
    </div>

    <div class="my-tab-content">
        <!-- Setup Chores Tab -->
        <div id="setup-tab" class="my-tab-pane active">
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>All Chores</h2>
                <button onclick="toggleModal('createChoreModal')">+ Create Chore</button>
            </div>
            <div class="card-body">
                {% if chores %}
                <!-- Tag Filter -->
                <div id="tagFilterSection" style="margin-bottom: var(--space-lg); display: none;">
                    <div style="display: flex; align-items: center; gap: var(--space-sm); flex-wrap: wrap;">
                        <strong style="color: var(--text-primary);">Filter by tag:</strong>
                        <button class="tag-filter-btn active" data-tag="all" onclick="filterByTag('all')"
                            style="padding: 0.375rem 0.75rem; background: var(--accent-primary); color: white; border: var(--border-sm) solid var(--accent-dark); font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 0.8125rem; box-shadow: var(--shadow-sm) var(--shadow-sm) 0 var(--accent-dark); transition: all 0.2s;">
                            All
                        </button>
                        <div id="tagFilters" style="display: flex; gap: var(--space-sm); flex-wrap: wrap;"></div>
                    </div>
                </div>
                <div class="row g-3">
                    {% for chore in chores %}
                    <div class="col-12 col-md-6 col-lg-4">
                        {% include 'private/parents/chores/components/chore_item.html' %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state text-center">
                    <p style="font-size: 1.1rem; color: var(--text-muted, #666);">No chores created yet</p>
                    <button class="btn-primary" onclick="toggleModal('createChoreModal')" style="margin-top: 1.5rem;">
                        + Create First Chore
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        </div>

        <!-- Active Chores Tab -->
        <div id="active-tab" class="my-tab-pane">
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Active Chore Assignments</h2>
            </div>
            <div class="card-body">
                {% if active_assignments %}
                    <div class="row g-3">
                        {% for assignment in active_assignments %}
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="assignment-item">
                                <div class="assignment-info">
                                    <strong>{{ assignment.kid.name }}</strong> - <strong>{{ assignment.chore.name }}</strong>
                                    {% if assignment.chore.description %}
                                        <p style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">{{ assignment.chore.description }}</p>
                                    {% endif %}
                                    <span class="timestamp">Assigned {{ assignment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                    <div class="coin-badge" style="margin-top: 0.5rem;">{{ assignment.chore.coin_value }} coins</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No active chore assignments</p>
                {% endif %}
            </div>
        </div>
        </div>

        <!-- Pending Approval Tab -->
        <div id="pending-tab" class="my-tab-pane">
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Pending Chore Approvals</h2>
            </div>
            <div class="card-body">
                {% if pending_assignments %}
                    <div class="row g-3">
                        {% for assignment in pending_assignments %}
                        <div class="col-12 col-md-6 col-lg-4">
                        <div class="assignment-item">
                            <div class="assignment-info">
                                <strong>{{ assignment.kid.name }}</strong> completed 
                                <strong>{{ assignment.chore.name }}</strong>
                                <span class="timestamp">{{ assignment.completed_at.strftime('%Y-%m-%d %H:%M') if assignment.completed_at else 'Just now' }}</span>
                            </div>
                            <div class="assignment-actions">
                                <form method="POST" action="{{ url_for('parent.confirm_chore', assignment_id=assignment.id) }}" class="inline-form">
                                    <input type="hidden" name="coin_adjustment" value="{{ assignment.chore.coin_value }}">
                                    <button type="submit" class="btn-success">
                                        ‚úì Approve (+{{ assignment.chore.coin_value }} coins)
                                    </button>
                                </form>
                                <button type="button" class="btn-primary" onclick="toggleModal('adjustApproveModal{{ assignment.id }}')">
                                    ‚öñÔ∏è Adjust & Approve
                                </button>
                                <button type="button" class="btn-danger" onclick="toggleModal('rejectModal{{ assignment.id }}')">
                                    ‚úó Reject
                                </button>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No pending chores</p>
                {% endif %}
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Adjust & Approve Modals -->
{% for assignment in pending_assignments %}
<div id="adjustApproveModal{{ assignment.id }}" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Adjust Coins & Approve</h3>
            <span class="close" onclick="toggleModal('adjustApproveModal{{ assignment.id }}')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('parent.confirm_chore', assignment_id=assignment.id) }}" data-assignment-id="{{ assignment.id }}">
            <div class="form-group">
                <label for="coin_adjustment_{{ assignment.id }}">Coin Amount</label>
                <input type="number" id="coin_adjustment_{{ assignment.id }}" name="coin_adjustment" 
                       value="{{ assignment.chore.coin_value }}" min="0" required placeholder="Enter coin amount">
                <small style="color: #666; font-size: 0.85em;">Original value: {{ assignment.chore.coin_value }} coins</small>
            </div>
            <div class="form-group">
                <strong>Kid:</strong> {{ assignment.kid.name }}<br>
                <strong>Chore:</strong> {{ assignment.chore.name }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('adjustApproveModal{{ assignment.id }}')">Cancel</button>
                <button type="submit" class="btn-success">‚úì Approve with Adjusted Amount</button>
            </div>
        </form>
    </div>
</div>

<div id="rejectModal{{ assignment.id }}" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Reject Chore</h3>
            <span class="close" onclick="toggleModal('rejectModal{{ assignment.id }}')">&times;</span>
        </div>
        <div class="form-group">
            <strong>Kid:</strong> {{ assignment.kid.name }}<br>
            <strong>Chore:</strong> {{ assignment.chore.name }}<br>
            <strong>Current Value:</strong> {{ assignment.chore.coin_value }} coins
        </div>
        <div class="form-group">
            <label style="display: block; margin-bottom: 15px;">
                <strong>What would you like to do?</strong>
            </label>
            
            <form method="POST" action="{{ url_for('parent.reject_chore', assignment_id=assignment.id) }}" data-assignment-id="{{ assignment.id }}" class="reject-form-cancel" style="margin-bottom: 15px;">
                <input type="hidden" name="reject_action" value="cancel">
                <button type="submit" class="btn btn-danger" style="width: 100%;">
                    ‚úó Cancel Chore Completely
                </button>
            </form>
            
            <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                <form method="POST" action="{{ url_for('parent.reject_chore', assignment_id=assignment.id) }}" data-assignment-id="{{ assignment.id }}" class="reject-form-redo">
                    <input type="hidden" name="reject_action" value="redo">
                    <div class="form-group">
                        <label for="new_coin_value_{{ assignment.id }}">Adjust Coins & Send Back for Redo</label>
                        <input type="number" id="new_coin_value_{{ assignment.id }}" name="new_coin_value" 
                               value="{{ assignment.chore.coin_value }}" min="0" required placeholder="New coin amount">
                        <small style="color: #666; font-size: 0.85em;">They'll need to redo it for this amount</small>
                    </div>
                    <button type="submit" class="btn btn-warning" style="width: 100%;">
                        ‚Ü©Ô∏è Send Back for Redo
                    </button>
                </form> 
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="toggleModal('rejectModal{{ assignment.id }}')">Cancel</button>
        </div>
    </div>
</div>
{% endfor %}

<!-- Create Chore Modal -->
<div id="createChoreModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Chore</h3>
            <span class="close" onclick="toggleModal('createChoreModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('parent.create_chore') }}">
            <div class="form-group mb-3">
                <label for="chore_name">Chore Name</label>
                <input type="text" id="chore_name" name="name" required placeholder="e.g., Clean room">
            </div>
            <div class="form-group mb-3">
                <label for="chore_description">Description (Optional)</label>
                <textarea id="chore_description" name="description" rows="3"
                    placeholder="Add details about what needs to be done..."
                    style="resize: vertical; min-height: 4rem;"></textarea>
            </div>
            <div class="form-group mb-3">
                <label for="chore_tags">Tags (Optional)</label>
                <input type="text" id="chore_tags" name="tags" placeholder="e.g., cleaning, outdoor, weekly">
                <small class="help-text">Separate multiple tags with commas</small>
            </div>
            <div class="form-group mb-3">
                <label for="coin_value">Coin Value</label>
                <input type="number" id="coin_value" name="coin_value" min="0" value="10" required>
            </div>
            <div class="form-group mb-3">
                <label for="point_value">Point Value</label>
                <input type="number" id="point_value" name="point_value" min="0" value="1" required>
            </div>
            <div class="form-group mb-3">
                <label for="frequency">Frequency</label>
                <select id="frequency" name="frequency" required>
                    <option value="unlimited">Unlimited (anytime)</option>
                    <option value="daily">Daily (once per day)</option>
                    <option value="weekly">Weekly (once per week)</option>
                    <option value="monthly">Monthly (once per month)</option>
                    <option value="one_time">One Time Only</option>
                </select>
                <small class="help-text">How often can this chore be done?</small>
            </div>
            <div class="form-group mb-3">
                <label
                    style="display: flex; align-items: center; gap: var(--space-sm); text-transform: none; cursor: pointer;">
                    <input type="checkbox" id="is_active" name="is_active" checked
                        style="width: auto; cursor: pointer;">
                    <span>Active (visible to kids)</span>
                </label>
                <small class="help-text">Uncheck to hide this chore from kids</small>
            </div>
            <div class="modal-footer d-flex flex-wrap gap-2 justify-content-end">
                <button type="button" class="btn-secondary" onclick="toggleModal('createChoreModal')">Cancel</button>
                <button type="submit" class="btn-primary">Create Chore</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Chore Modal -->
<div id="editChoreModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Chore</h3>
            <span class="close" onclick="toggleModal('editChoreModal')">&times;</span>
        </div>
        <form id="editChoreForm" method="POST">
            <div class="form-group mb-3">
                <label for="edit_chore_name">Chore Name</label>
                <input type="text" id="edit_chore_name" name="name" required placeholder="e.g., Clean room">
            </div>
            <div class="form-group mb-3">
                <label for="edit_chore_description">Description (Optional)</label>
                <textarea id="edit_chore_description" name="description" rows="3"
                    placeholder="Add details about what needs to be done..."
                    style="resize: vertical; min-height: 4rem;"></textarea>
            </div>
            <div class="form-group mb-3">
                <label for="edit_chore_tags">Tags (Optional)</label>
                <input type="text" id="edit_chore_tags" name="tags" placeholder="e.g., cleaning, outdoor, weekly">
                <small class="help-text">Separate multiple tags with commas</small>
            </div>
            <div class="form-group mb-3">
                <label for="edit_coin_value">Coin Value</label>
                <input type="number" id="edit_coin_value" name="coin_value" min="0" required>
            </div>
            <div class="form-group mb-3">
                <label for="edit_point_value">Point Value</label>
                <input type="number" id="edit_point_value" name="point_value" min="0" required>
            </div>
            <div class="form-group mb-3">
                <label for="edit_frequency">Frequency</label>
                <select id="edit_frequency" name="frequency" required>
                    <option value="unlimited">Unlimited (anytime)</option>
                    <option value="daily">Daily (once per day)</option>
                    <option value="weekly">Weekly (once per week)</option>
                    <option value="monthly">Monthly (once per month)</option>
                    <option value="one_time">One Time Only</option>
                </select>
                <small class="help-text">How often can this chore be done?</small>
            </div>
            <div class="form-group mb-3">
                <label
                    style="display: flex; align-items: center; gap: var(--space-sm); text-transform: none; cursor: pointer;">
                    <input type="checkbox" id="edit_is_active" name="is_active" style="width: auto; cursor: pointer;">
                    <span>Active (visible to kids)</span>
                </label>
                <small class="help-text">Uncheck to hide this chore from kids</small>
            </div>
            <div class="modal-footer d-flex flex-wrap gap-2 justify-content-end">
                <button type="button" class="btn-secondary" onclick="toggleModal('editChoreModal')">Cancel</button>
                <button type="submit" class="btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/api.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/tabs.js') }}"></script>
<script>
    function toggleModal(modalId) {
        document.getElementById(modalId).classList.toggle('active');
    }

    // Edit chore buttons - use event delegation
    document.addEventListener('DOMContentLoaded', function () {
        // Setup AJAX for create chore form
        setupAjaxForm('#createChoreModal form', {
            closeModal: 'createChoreModal',
            onSuccess: () => {
                location.reload();
            }
        });
        
        // Setup AJAX for edit chore form
        setupAjaxForm('#editChoreForm', {
            closeModal: 'editChoreModal',
            onSuccess: () => {
                location.reload();
            }
        });
        
        // Handle toggle chore forms (in cards and modals)
        document.querySelectorAll('form[action*="toggle-chore"]').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                await submitForm(form, {
                    onSuccess: (data) => {
                        // Update the button text
                        const button = form.querySelector('button[type="submit"]');
                        if (button) {
                            button.textContent = data.is_active ? '‚úì Active' : 'üëÅÔ∏è Hidden';
                            button.className = `status-badge ${data.is_active ? 'active' : 'inactive'}`;
                            button.title = `Click to ${data.is_active ? 'hide' : 'show'}`;
                        }
                    }
                });
            });
        });
        
        // Handle delete buttons
        document.querySelectorAll('.delete-chore-btn').forEach(function (btn) {
            btn.addEventListener('click', async function () {
                const choreId = this.dataset.choreId;
                const choreName = this.dataset.choreName;
                if (confirm('Delete ' + choreName + '? This cannot be undone.')) {
                    const form = document.getElementById('delete-form-' + choreId);
                    await submitForm(form, {
                        onSuccess: () => {
                            // Remove the chore card
                            const choreCard = form.closest('.col-12, .col-md-6');
                            if (choreCard) {
                                removeElement(choreCard);
                            }
                        }
                    });
                }
            });
        });
        
        // Handle edit buttons
        document.querySelectorAll('.edit-chore-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const choreId = this.dataset.choreId;
                const name = this.dataset.choreName;
                const description = this.dataset.choreDescription;
                const tags = this.dataset.choreTags;
                const coinValue = this.dataset.choreCoin;
                const pointValue = this.dataset.chorePoint;
                const frequency = this.dataset.choreFrequency;
                const isActive = this.dataset.choreActive === 'true';

                // Set form action
                document.getElementById('editChoreForm').action = '/parent/edit-chore/' + choreId;

                // Populate form fields
                document.getElementById('edit_chore_name').value = name;
                document.getElementById('edit_chore_description').value = description || '';
                document.getElementById('edit_chore_tags').value = tags || '';
                document.getElementById('edit_coin_value').value = coinValue;
                document.getElementById('edit_point_value').value = pointValue;
                document.getElementById('edit_frequency').value = frequency;
                document.getElementById('edit_is_active').checked = isActive;

                // Open modal
                toggleModal('editChoreModal');
            });
        });

        // Handle view details buttons
        document.querySelectorAll('.view-chore-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const choreId = this.dataset.choreId;
                toggleModal('choreDetailsModal-' + choreId);
            });
        });

        // Tag filtering system
        const allTags = new Set();

        // Collect all unique tags from chores
        document.querySelectorAll('.chore-item').forEach(function (item) {
            const tags = item.dataset.choreTags;
            if (tags) {
                tags.split(',').forEach(function (tag) {
                    const trimmed = tag.trim();
                    if (trimmed) {
                        allTags.add(trimmed);
                    }
                });
            }
        });

        // Populate filter buttons if tags exist
        if (allTags.size > 0) {
            const tagFilters = document.getElementById('tagFilters');
            allTags.forEach(function (tag) {
                const btn = document.createElement('button');
                btn.className = 'tag-filter-btn';
                btn.dataset.tag = tag;
                btn.textContent = '#' + tag;
                btn.style.cssText = 'padding: 0.375rem 0.75rem; background: var(--bg-light); color: var(--text-primary); border: var(--border-sm) solid var(--accent-dark); font-weight: 700; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease;';
                btn.onclick = function () { filterByTag(tag); };
                tagFilters.appendChild(btn);
            });

            // Show filter section
            document.getElementById('tagFilterSection').style.display = 'block';
        }

        // Filter function
        window.filterByTag = function (tag) {
            document.querySelectorAll('.chore-item').forEach(function (item) {
                const tags = item.dataset.choreTags;
                const col = item.closest('.col-12, .col-md-6');

                if (tag === 'all') {
                    col.style.display = 'block';
                } else if (tags && tags.split(',').some(function (t) { return t.trim() === tag; })) {
                    col.style.display = 'block';
                } else {
                    col.style.display = 'none';
                }
            });

            // Update active button styling
            document.querySelectorAll('.tag-filter-btn').forEach(function (btn) {
                if (btn.dataset.tag === tag) {
                    btn.classList.add('active');
                    btn.style.background = 'var(--accent-primary)';
                    btn.style.color = 'white';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'var(--bg-light)';
                    btn.style.color = 'var(--text-primary)';
                }
            });
        };

        // Chore Approval/Rejection Forms
        document.querySelectorAll('form[action*="confirm-chore"], form[action*="reject-chore"]').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const assignmentId = form.getAttribute('data-assignment-id');
                const assignment = form.closest('.assignment-item');
                
                await submitForm(form, {
                    onSuccess: (data) => {
                        // Close modal if this was from a modal form
                        if (assignmentId) {
                            let modalId = 'adjustApproveModal' + assignmentId;
                            let modal = document.getElementById(modalId);
                            if (modal && modal.classList.contains('active')) {
                                modal.classList.remove('active');
                            }
                            
                            modalId = 'rejectModal' + assignmentId;
                            modal = document.getElementById(modalId);
                            if (modal && modal.classList.contains('active')) {
                                modal.classList.remove('active');
                            }
                        }
                        
                        // Reload to update counts and lists
                        location.reload();
                    }
                });
            });
        });
    });
</script>
{% endblock %}