{% extends "bases/private.html" %}

{% block title %}Parent Dashboard - Bold Flat{% endblock %}

{% block content %}

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="text-center text-md-start">{{ family.name }} Dashboard</h1>
        <p class="text-center text-md-start">Simple. Bold. Effective.</p>
        <div class="family-code-display d-flex flex-wrap align-items-center justify-content-center justify-content-md-start gap-2">
            <strong>Family Code:</strong> <span class="family-code">{{ family.family_code }}</span>
            <button onclick="copyFamilyCode('{{ family.family_code }}')">üìã Copy</button>
        </div>
    </div>

    {% include 'private/parents/components/navbar.html' %}

    <div class="dashboard-grid">
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Kids</h2>
                <button onclick="toggleModal('addKidModal')">+ Add Kid</button>
            </div>
            <div class="card-body">
                {% if kids %}
                    <div class="row g-3">
                        {% for kid in kids %}
                        <div class="col-12 col-md-6 col-lg-4">
                        <div class="kid-item">
                            <div class="kid-info">
                                <strong>{{ kid.name }}</strong>
                                <span class="coin-badge">{{ kid.coin_balance }} Coins</span>
                            </div>
                            <div class="kid-actions">
                                <button type="button" onclick="toggleModal('adjustCoinsModal{{ kid.id }}')">üí∞ Adjust Coins</button>
                                <button type="button" onclick="toggleModal('resetPinModal{{ kid.id }}')">üîë Reset PIN</button>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No kids added yet</p>
                {% endif %}
            </div>
        </div>

        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Pending Chore Approvals</h2>
            </div>
            <div class="card-body">
                {% if pending_assignments %}
                    <div class="row g-3">
                        {% for assignment in pending_assignments %}
                        <div class="col-12 col-md-6 col-lg-4">
                        <div class="assignment-item">
                            <div class="assignment-info">
                                <strong>{{ assignment.kid.name }}</strong> completed 
                                <strong>{{ assignment.chore.name }}</strong>
                                <span class="timestamp">{{ assignment.completed_at.strftime('%Y-%m-%d %H:%M') if assignment.completed_at else 'Just now' }}</span>
                            </div>
                            <div class="assignment-actions">
                                <form method="POST" action="{{ url_for('parent.confirm_chore', assignment_id=assignment.id) }}" class="inline-form">
                                    <input type="hidden" name="coin_adjustment" value="{{ assignment.chore.coin_value }}">
                                    <button type="submit" class="btn-success">
                                        ‚úì Approve (+{{ assignment.chore.coin_value }} coins)
                                    </button>
                                </form>
                                <button type="button" class="btn-primary" onclick="toggleModal('adjustApproveModal{{ assignment.id }}')">
                                    ‚öñÔ∏è Adjust & Approve
                                </button>
                                <form method="POST" action="{{ url_for('parent.reject_chore', assignment_id=assignment.id) }}" class="inline-form">
                                    <button type="submit" class="btn-danger">‚úó Reject</button>
                                </form>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No pending chores</p>
                {% endif %}
            </div>
        </div>

        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Pending Purchase Requests</h2>
            </div>
            <div class="card-body">
                {% if pending_purchases %}
                    <div class="row g-3">
                        {% for purchase in pending_purchases %}
                        <div class="col-12 col-md-6 col-lg-4">
                        <div class="assignment-item">
                            <div class="assignment-info">
                                <strong>{{ purchase.kid.name }}</strong> wants to purchase 
                                <strong>{{ purchase.item.name }}</strong>
                                {% if purchase.item.description %}
                                    <span>- {{ purchase.item.description }}</span>
                                {% endif %}
                                <span class="timestamp">{{ purchase.purchased_at.strftime('%Y-%m-%d %H:%M') if purchase.purchased_at else 'Just now' }}</span>
                                <div class="purchase-cost">{{ purchase.coin_cost }} coins</div>
                            </div>
                            <div class="assignment-actions">
                                <form method="POST" action="{{ url_for('parent.fulfill_purchase', purchase_id=purchase.id) }}" class="inline-form">
                                    <button type="submit" class="btn-success">‚úì Fulfill</button>
                                </form>
                                <form method="POST" action="{{ url_for('parent.cancel_purchase', purchase_id=purchase.id) }}" class="inline-form">
                                    <button type="submit" class="btn-danger">‚úó Cancel & Refund</button>
                                </form>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No pending purchases</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="addKidModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Kid</h3>
            <span class="close" onclick="toggleModal('addKidModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('parent.add_kid') }}">
            <div class="form-group">
                <label for="kid_name">Kid's Name</label>
                <input type="text" id="kid_name" name="name" required placeholder="Enter kid's name">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="use_random_pin" name="use_random_pin" checked onchange="togglePinInput()">
                    Generate Random PIN
                </label>
            </div>
            <div class="form-group" id="custom_pin_group" style="display: none;">
                <label for="custom_pin">Custom PIN (4 digits)</label>
                <input type="text" id="custom_pin" name="custom_pin" maxlength="4" pattern="\d{4}" placeholder="Enter 4-digit PIN">
                <small style="color: #666; font-size: 0.85em;">Enter exactly 4 digits</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('addKidModal')">Cancel</button>
                <button type="submit" class="btn-primary">Add Kid</button>
            </div>
        </form>
    </div>
</div>

{% for kid in kids %}
<div id="resetPinModal{{ kid.id }}" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Reset PIN: {{ kid.name }}</h3>
            <span class="close" onclick="toggleModal('resetPinModal{{ kid.id }}')">√ó</span>
        </div>
        <form method="POST" action="{{ url_for('parent.reset_pin', kid_id=kid.id) }}" data-kid-id="{{ kid.id }}">
            <div class="form-group">
                <label>
                    <input type="checkbox" id="use_random_pin_{{ kid.id }}" name="use_random_pin" checked onchange="toggleResetPinInput({{ kid.id }})">
                    Generate Random PIN
                </label>
            </div>
            <div class="form-group" id="custom_pin_group_{{ kid.id }}" style="display: none;">
                <label for="custom_pin_{{ kid.id }}">Custom PIN (4 digits)</label>
                <input type="text" id="custom_pin_{{ kid.id }}" name="custom_pin" maxlength="4" pattern="\d{4}" placeholder="Enter 4-digit PIN">
                <small style="color: #666; font-size: 0.85em;">Enter exactly 4 digits</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('resetPinModal{{ kid.id }}')">Cancel</button>
                <button type="submit" class="btn-primary">Reset PIN</button>
            </div>
        </form>
    </div>
</div>

<div id="adjustCoinsModal{{ kid.id }}" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Adjust Coins: {{ kid.name }}</h3>
            <span class="close" onclick="toggleModal('adjustCoinsModal{{ kid.id }}')">√ó</span>
        </div>
        <form method="POST" action="{{ url_for('parent.adjust_coins', kid_id=kid.id) }}">
            <div class="form-group">
                <label>Action</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="action" value="add" checked>
                        ‚ûï Add Coins
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="action" value="subtract">
                        ‚ûñ Subtract Coins
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="amount{{ kid.id }}">Amount</label>
                <input type="number" id="amount{{ kid.id }}" name="amount" min="1" required placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label for="reason{{ kid.id }}">Reason (optional)</label>
                <input type="text" id="reason{{ kid.id }}" name="reason" placeholder="e.g., Good behavior">
                <small class="help-text">Shown to {{ kid.name }}</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('adjustCoinsModal{{ kid.id }}')" >Cancel</button>
                <button type="submit" class="btn-primary">Confirm</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

{% for assignment in pending_assignments %}
<div id="adjustApproveModal{{ assignment.id }}" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Adjust Coins & Approve</h3>
            <span class="close" onclick="toggleModal('adjustApproveModal{{ assignment.id }}')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('parent.confirm_chore', assignment_id=assignment.id) }}" data-assignment-id="{{ assignment.id }}">
            <div class="form-group">
                <label for="coin_adjustment_{{ assignment.id }}">Coin Amount</label>
                <input type="number" id="coin_adjustment_{{ assignment.id }}" name="coin_adjustment" 
                       value="{{ assignment.chore.coin_value }}" min="0" required placeholder="Enter coin amount">
                <small style="color: #666; font-size: 0.85em;">Original value: {{ assignment.chore.coin_value }} coins</small>
            </div>
            <div class="form-group">
                <strong>Kid:</strong> {{ assignment.kid.name }}<br>
                <strong>Chore:</strong> {{ assignment.chore.name }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('adjustApproveModal{{ assignment.id }}')">Cancel</button>
                <button type="submit" class="btn-success">‚úì Approve with Adjusted Amount</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/api.js') }}"></script>
<script>
function copyFamilyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        showMessage('Family code copied!', 'success');
    });
}

function toggleModal(modalId) {
    document.getElementById(modalId).classList.toggle('active');
}

function togglePinInput() {
    const checkbox = document.getElementById('use_random_pin');
    const customPinGroup = document.getElementById('custom_pin_group');
    const customPinInput = document.getElementById('custom_pin');
    
    if (checkbox.checked) {
        customPinGroup.style.display = 'none';
        customPinInput.removeAttribute('required');
        customPinInput.value = '';
    } else {
        customPinGroup.style.display = 'block';
        customPinInput.setAttribute('required', 'required');
    }
}

function toggleResetPinInput(kidId) {
    const checkbox = document.getElementById('use_random_pin_' + kidId);
    const customPinGroup = document.getElementById('custom_pin_group_' + kidId);
    const customPinInput = document.getElementById('custom_pin_' + kidId);
    
    if (checkbox.checked) {
        customPinGroup.style.display = 'none';
        customPinInput.removeAttribute('required');
        customPinInput.value = '';
    } else {
        customPinGroup.style.display = 'block';
        customPinInput.setAttribute('required', 'required');
    }
}

// Setup AJAX for all forms
document.addEventListener('DOMContentLoaded', function() {
    // Add Kid Form - Custom handling for checkbox
    const addKidForm = document.querySelector('#addKidModal form');
    if (addKidForm) {
        addKidForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(addKidForm);
            // Ensure checkbox state is sent correctly
            const checkbox = document.getElementById('use_random_pin');
            formData.set('use_random_pin', checkbox.checked ? 'true' : 'false');
            
            try {
                const response = await fetch(addKidForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    document.getElementById('addKidModal').classList.remove('active');
                    addKidForm.reset();
                    location.reload();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error adding kid:', error);
                showMessage('An error occurred. Please try again.', 'error');
            }
        });
    }
    
    // Adjust Coins Forms
    document.querySelectorAll('[id^="adjustCoinsModal"]').forEach(modal => {
        const form = modal.querySelector('form');
        setupAjaxForm(form, {
            closeModal: modal.id,
            onSuccess: (data) => {
                // Update coin balance in UI
                if (data.kid_id) {
                    const coinBadge = document.querySelector(`.kid-item [data-kid-id="${data.kid_id}"] .coin-badge`);
                    if (coinBadge) {
                        coinBadge.textContent = `${data.new_balance} Coins`;
                    }
                }
                location.reload();
            }
        });
    });
    
    // Reset PIN Forms
    document.querySelectorAll('form[action*="reset-pin"]').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const kidId = form.getAttribute('data-kid-id');
            const checkbox = document.getElementById('use_random_pin_' + kidId);
            formData.set('use_random_pin', checkbox.checked ? 'true' : 'false');
            
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    const modalId = 'resetPinModal' + kidId;
                    document.getElementById(modalId).classList.remove('active');
                    form.reset();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error resetting PIN:', error);
                showMessage('An error occurred. Please try again.', 'error');
            }
        });
    });
    
    // Chore Approval/Rejection Forms (including adjust & approve modals)
    document.querySelectorAll('form[action*="confirm-chore"], form[action*="reject-chore"]').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const assignmentId = form.getAttribute('data-assignment-id');
            const assignment = form.closest('.assignment-item');
            
            await submitForm(form, {
                onSuccess: (data) => {
                    // Close modal if this was from adjust & approve
                    if (assignmentId) {
                        const modalId = 'adjustApproveModal' + assignmentId;
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.classList.remove('active');
                        }
                    }
                    
                    // Remove the assignment card
                    if (assignment) {
                        removeElement(assignment.closest('.col-12, .col-md-6'));
                    }
                    
                    // Update kid coin balance if provided
                    if (data.kid_id && data.new_balance !== undefined) {
                        const coinBadge = document.querySelector(`.kid-item [data-kid-id="${data.kid_id}"] .coin-badge`);
                        if (coinBadge) {
                            coinBadge.textContent = `${data.new_balance} Coins`;
                        }
                    }
                }
            });
        });
    });
    
    // Purchase Fulfillment/Cancellation Forms
    document.querySelectorAll('form[action*="fulfill-purchase"], form[action*="cancel-purchase"]').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const purchaseItem = form.closest('.assignment-item');
            await submitForm(form, {
                onSuccess: (data) => {
                    // Remove the purchase card
                    if (purchaseItem) {
                        removeElement(purchaseItem.closest('.col-12, .col-md-6'));
                    }
                    
                    // Update kid coin balance if refunded
                    if (data.kid_id && data.new_balance !== undefined) {
                        const coinBadge = document.querySelector(`.kid-item [data-kid-id="${data.kid_id}"] .coin-badge`);
                        if (coinBadge) {
                            coinBadge.textContent = `${data.new_balance} Coins`;
                        }
                    }
                }
            });
        });
    });
});
</script>
{% endblock %}
