{% extends "bases/private.html" %}

{% block title %}Parent Dashboard - Bold Flat{% endblock %}

{% block content %}

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="text-center text-md-start">{{ family.name }} Dashboard</h1>
        <p class="text-center text-md-start">Simple. Bold. Effective.</p>
        <div class="family-code-display d-flex flex-wrap align-items-center justify-content-center justify-content-md-start gap-2">
            <strong>Family Code:</strong> <span class="family-code">{{ family.family_code }}</span>
            <button onclick="copyFamilyCode('{{ family.family_code }}')">ðŸ“‹ Copy</button>
        </div>
    </div>

    {% include 'private/parents/components/navbar.html' %}

    <div class="dashboard-grid">
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Kids</h2>
                <button onclick="toggleModal('addKidModal')">+ Add Kid</button>
            </div>
            <div class="card-body">
                {% if kids %}
                    <div class="row g-3">
                        {% for kid in kids %}
                        <div class="col-12 col-md-6 col-lg-4">
                        <div class="kid-item">
                            <div class="kid-info">
                                <strong>{{ kid.name }}</strong>
                                <span class="coin-badge">{{ kid.coin_balance }} Coins</span>
                            </div>
                            <div class="kid-actions">
                                <button type="button" onclick="toggleModal('adjustCoinsModal{{ kid.id }}')">ðŸ’° Adjust Coins</button>
                                <form method="POST" action="{{ url_for('parent.reset_pin', kid_id=kid.id) }}" class="inline-form" onsubmit="return confirm('Reset PIN for {{ kid.name }}?');">
                                    <button type="submit">ðŸ”‘ Reset PIN</button>
                                </form>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No kids added yet</p>
                {% endif %}
            </div>
        </div>

        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Pending Chore Approvals</h2>
            </div>
            <div class="card-body">
                {% if pending_assignments %}
                    <div class="row g-3">
                        {% for assignment in pending_assignments %}
                        <div class="col-12 col-md-6 col-lg-4">
                        <div class="assignment-item">
                            <div class="assignment-info">
                                <strong>{{ assignment.kid.name }}</strong> completed 
                                <strong>{{ assignment.chore.name }}</strong>
                                <span class="timestamp">{{ assignment.completed_at.strftime('%Y-%m-%d %H:%M') if assignment.completed_at else 'Just now' }}</span>
                            </div>
                            <div class="assignment-actions">
                                <form method="POST" action="{{ url_for('parent.confirm_chore', assignment_id=assignment.id) }}" class="inline-form">
                                    <input type="hidden" name="coin_adjustment" value="{{ assignment.chore.coin_value }}">
                                    <button type="submit" class="btn-success">
                                        âœ“ Approve (+{{ assignment.chore.coin_value }} coins)
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('parent.reject_chore', assignment_id=assignment.id) }}" class="inline-form">
                                    <button type="submit" class="btn-danger">âœ— Reject</button>
                                </form>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No pending chores</p>
                {% endif %}
            </div>
        </div>

        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Pending Purchase Requests</h2>
            </div>
            <div class="card-body">
                {% if pending_purchases %}
                    <div class="row g-3">
                        {% for purchase in pending_purchases %}
                        <div class="col-12 col-md-6 col-lg-4">
                        <div class="assignment-item">
                            <div class="assignment-info">
                                <strong>{{ purchase.kid.name }}</strong> wants to purchase 
                                <strong>{{ purchase.item.name }}</strong>
                                {% if purchase.item.description %}
                                    <span>- {{ purchase.item.description }}</span>
                                {% endif %}
                                <span class="timestamp">{{ purchase.purchased_at.strftime('%Y-%m-%d %H:%M') if purchase.purchased_at else 'Just now' }}</span>
                                <div class="purchase-cost">{{ purchase.coin_cost }} coins</div>
                            </div>
                            <div class="assignment-actions">
                                <form method="POST" action="{{ url_for('parent.fulfill_purchase', purchase_id=purchase.id) }}" class="inline-form">
                                    <button type="submit" class="btn-success">âœ“ Fulfill</button>
                                </form>
                                <form method="POST" action="{{ url_for('parent.cancel_purchase', purchase_id=purchase.id) }}" class="inline-form">
                                    <button type="submit" class="btn-danger">âœ— Cancel & Refund</button>
                                </form>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No pending purchases</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="addKidModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Kid</h3>
            <span class="close" onclick="toggleModal('addKidModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('parent.add_kid') }}">
            <div class="form-group">
                <label for="kid_name">Kid's Name</label>
                <input type="text" id="kid_name" name="name" required placeholder="Enter kid's name">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('addKidModal')">Cancel</button>
                <button type="submit" class="btn-primary">Add Kid</button>
            </div>
        </form>
    </div>
</div>

{% for kid in kids %}
<div id="adjustCoinsModal{{ kid.id }}" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Adjust Coins: {{ kid.name }}</h3>
            <span class="close" onclick="toggleModal('adjustCoinsModal{{ kid.id }}')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('parent.adjust_coins', kid_id=kid.id) }}">
            <div class="form-group">
                <label>Action</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="action" value="add" checked>
                        âž• Add Coins
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="action" value="subtract">
                        âž– Subtract Coins
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="amount{{ kid.id }}">Amount</label>
                <input type="number" id="amount{{ kid.id }}" name="amount" min="1" required placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label for="reason{{ kid.id }}">Reason (optional)</label>
                <input type="text" id="reason{{ kid.id }}" name="reason" placeholder="e.g., Good behavior">
                <small class="help-text">Shown to {{ kid.name }}</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('adjustCoinsModal{{ kid.id }}')" >Cancel</button>
                <button type="submit" class="btn-primary">Confirm</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
function copyFamilyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        alert('Family code copied!');
    });
}

function toggleModal(modalId) {
    document.getElementById(modalId).classList.toggle('active');
}
</script>
{% endblock %}
