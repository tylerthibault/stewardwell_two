{% extends "bases/private.html" %}

{% block title %}Parent Dashboard - Bold Flat{% endblock %}

{% block content %}

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="text-center text-md-start">{{ family.name }} Dashboard</h1>
        <p class="text-center text-md-start">Simple. Bold. Effective.</p>
        <div class="family-code-display d-flex flex-wrap align-items-center justify-content-center justify-content-md-start gap-2">
            <strong>Family Code:</strong> <span class="family-code">{{ family.family_code }}</span>
            <button onclick="copyFamilyCode('{{ family.family_code }}')">üìã Copy</button>
        </div>
    </div>

    {% include 'private/parents/components/navbar.html' %}

    <!-- Quick Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="stat-card">
                <div class="stat-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                <div class="stat-content">
                    <div class="stat-value">{{ kids|length }}</div>
                    <div class="stat-label">Kids</div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <a href="{{ url_for('parent.chores') }}#pending-tab" class="stat-card-link">
                <div class="stat-card {% if pending_assignments %}stat-card-alert{% endif %}">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <div class="stat-value">{{ pending_assignments|length }}</div>
                        <div class="stat-label">Chores to Approve</div>
                    </div>
                    {% if pending_assignments %}
                    <div class="stat-badge">{{ pending_assignments|length }}</div>
                    {% endif %}
                </div>
            </a>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <a href="{{ url_for('parent.store') }}#pending-tab" class="stat-card-link">
                <div class="stat-card {% if pending_purchases %}stat-card-alert{% endif %}">
                    <div class="stat-icon">üõí</div>
                    <div class="stat-content">
                        <div class="stat-value">{{ pending_purchases|length }}</div>
                        <div class="stat-label">Purchases to Fulfill</div>
                    </div>
                    {% if pending_purchases %}
                    <div class="stat-badge">{{ pending_purchases|length }}</div>
                    {% endif %}
                </div>
            </a>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="stat-card">
                <div class="stat-icon">ü™ô</div>
                <div class="stat-content">
                    <div class="stat-value">{{ kids|sum(attribute='coin_balance') }}</div>
                    <div class="stat-label">Total Coins</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kids Management -->
    <div class="dashboard-grid">
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Manage Kids</h2>
                <button onclick="toggleModal('addKidModal')">+ Add Kid</button>
            </div>
            <div class="card-body">
                {% if kids %}
                    <div class="row g-3">
                        {% for kid in kids %}
                        <div class="col-12 col-md-6 col-lg-4">
                        <div class="kid-item">
                            <div class="kid-info">
                                <strong>{{ kid.name }}</strong>
                                <span class="coin-badge">{{ kid.coin_balance }} Coins</span>
                            </div>
                            <div class="kid-actions">
                                <button type="button" onclick="toggleModal('adjustCoinsModal{{ kid.id }}')">üí∞ Adjust Coins</button>
                                <button type="button" onclick="toggleModal('resetPinModal{{ kid.id }}')">üîë Reset PIN</button>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No kids added yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="addKidModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Kid</h3>
            <span class="close" onclick="toggleModal('addKidModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('parent.add_kid') }}">
            <div class="form-group">
                <label for="kid_name">Kid's Name</label>
                <input type="text" id="kid_name" name="name" required placeholder="Enter kid's name">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="use_random_pin" name="use_random_pin" checked onchange="togglePinInput()">
                    Generate Random PIN
                </label>
            </div>
            <div class="form-group" id="custom_pin_group" style="display: none;">
                <label for="custom_pin">Custom PIN (4 digits)</label>
                <input type="text" id="custom_pin" name="custom_pin" maxlength="4" pattern="\d{4}" placeholder="Enter 4-digit PIN">
                <small style="color: #666; font-size: 0.85em;">Enter exactly 4 digits</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('addKidModal')">Cancel</button>
                <button type="submit" class="btn-primary">Add Kid</button>
            </div>
        </form>
    </div>
</div>

{% for kid in kids %}
<div id="resetPinModal{{ kid.id }}" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Reset PIN: {{ kid.name }}</h3>
            <span class="close" onclick="toggleModal('resetPinModal{{ kid.id }}')">√ó</span>
        </div>
        <form method="POST" action="{{ url_for('parent.reset_pin', kid_id=kid.id) }}" data-kid-id="{{ kid.id }}">
            <div class="form-group">
                <label>
                    <input type="checkbox" id="use_random_pin_{{ kid.id }}" name="use_random_pin" checked onchange="toggleResetPinInput({{ kid.id }})">
                    Generate Random PIN
                </label>
            </div>
            <div class="form-group" id="custom_pin_group_{{ kid.id }}" style="display: none;">
                <label for="custom_pin_{{ kid.id }}">Custom PIN (4 digits)</label>
                <input type="text" id="custom_pin_{{ kid.id }}" name="custom_pin" maxlength="4" pattern="\d{4}" placeholder="Enter 4-digit PIN">
                <small style="color: #666; font-size: 0.85em;">Enter exactly 4 digits</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('resetPinModal{{ kid.id }}')">Cancel</button>
                <button type="submit" class="btn-primary">Reset PIN</button>
            </div>
        </form>
    </div>
</div>

<div id="adjustCoinsModal{{ kid.id }}" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Adjust Coins: {{ kid.name }}</h3>
            <span class="close" onclick="toggleModal('adjustCoinsModal{{ kid.id }}')">√ó</span>
        </div>
        <form method="POST" action="{{ url_for('parent.adjust_coins', kid_id=kid.id) }}">
            <div class="form-group">
                <label>Action</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="action" value="add" checked>
                        ‚ûï Add Coins
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="action" value="subtract">
                        ‚ûñ Subtract Coins
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="amount{{ kid.id }}">Amount</label>
                <input type="number" id="amount{{ kid.id }}" name="amount" min="1" required placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label for="reason{{ kid.id }}">Reason (optional)</label>
                <input type="text" id="reason{{ kid.id }}" name="reason" placeholder="e.g., Good behavior">
                <small class="help-text">Shown to {{ kid.name }}</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('adjustCoinsModal{{ kid.id }}')" >Cancel</button>
                <button type="submit" class="btn-primary">Confirm</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

{% for assignment in pending_assignments %}
<div id="adjustApproveModal{{ assignment.id }}" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Adjust Coins & Approve</h3>
            <span class="close" onclick="toggleModal('adjustApproveModal{{ assignment.id }}')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('parent.confirm_chore', assignment_id=assignment.id) }}" data-assignment-id="{{ assignment.id }}">
            <div class="form-group">
                <label for="coin_adjustment_{{ assignment.id }}">Coin Amount</label>
                <input type="number" id="coin_adjustment_{{ assignment.id }}" name="coin_adjustment" 
                       value="{{ assignment.chore.coin_value }}" min="0" required placeholder="Enter coin amount">
                <small style="color: #666; font-size: 0.85em;">Original value: {{ assignment.chore.coin_value }} coins</small>
            </div>
            <div class="form-group">
                <strong>Kid:</strong> {{ assignment.kid.name }}<br>
                <strong>Chore:</strong> {{ assignment.chore.name }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('adjustApproveModal{{ assignment.id }}')">Cancel</button>
                <button type="submit" class="btn-success">‚úì Approve with Adjusted Amount</button>
            </div>
        </form>
    </div>
</div>

<div id="rejectModal{{ assignment.id }}" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Reject Chore</h3>
            <span class="close" onclick="toggleModal('rejectModal{{ assignment.id }}')">&times;</span>
        </div>
        <div class="form-group">
            <strong>Kid:</strong> {{ assignment.kid.name }}<br>
            <strong>Chore:</strong> {{ assignment.chore.name }}<br>
            <strong>Current Value:</strong> {{ assignment.chore.coin_value }} coins
        </div>
        <div class="form-group">
            <label style="display: block; margin-bottom: 15px;">
                <strong>What would you like to do?</strong>
            </label>
            
            <form method="POST" action="{{ url_for('parent.reject_chore', assignment_id=assignment.id) }}" data-assignment-id="{{ assignment.id }}" class="reject-form-cancel" style="margin-bottom: 15px;">
                <input type="hidden" name="reject_action" value="cancel">
                <button type="submit" class="btn btn-danger" style="width: 100%;">
                    ‚úó Cancel Chore Completely
                </button>
            </form>
            
            <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                <form method="POST" action="{{ url_for('parent.reject_chore', assignment_id=assignment.id) }}" data-assignment-id="{{ assignment.id }}" class="reject-form-redo">
                    <input type="hidden" name="reject_action" value="redo">
                    <div class="form-group">
                        <label for="new_coin_value_{{ assignment.id }}">Adjust Coins & Send Back for Redo</label>
                        <input type="number" id="new_coin_value_{{ assignment.id }}" name="new_coin_value" 
                               value="{{ assignment.chore.coin_value }}" min="0" required placeholder="New coin amount">
                        <small style="color: #666; font-size: 0.85em;">They'll need to redo it for this amount</small>
                    </div>
                    <button type="submit" class="btn btn-warning" style="width: 100%;">
                        ‚Ü©Ô∏è Send Back for Redo
                    </button>
                </form> 
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="toggleModal('rejectModal{{ assignment.id }}')">Cancel</button>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/api.js') }}"></script>
<script>
function copyFamilyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        showMessage('Family code copied!', 'success');
    });
}

function toggleModal(modalId) {
    document.getElementById(modalId).classList.toggle('active');
}

function togglePinInput() {
    const checkbox = document.getElementById('use_random_pin');
    const customPinGroup = document.getElementById('custom_pin_group');
    const customPinInput = document.getElementById('custom_pin');
    
    if (checkbox.checked) {
        customPinGroup.style.display = 'none';
        customPinInput.removeAttribute('required');
        customPinInput.value = '';
    } else {
        customPinGroup.style.display = 'block';
        customPinInput.setAttribute('required', 'required');
    }
}

function toggleResetPinInput(kidId) {
    const checkbox = document.getElementById('use_random_pin_' + kidId);
    const customPinGroup = document.getElementById('custom_pin_group_' + kidId);
    const customPinInput = document.getElementById('custom_pin_' + kidId);
    
    if (checkbox.checked) {
        customPinGroup.style.display = 'none';
        customPinInput.removeAttribute('required');
        customPinInput.value = '';
    } else {
        customPinGroup.style.display = 'block';
        customPinInput.setAttribute('required', 'required');
    }
}

// Setup AJAX for all forms
document.addEventListener('DOMContentLoaded', function() {
    // Add Kid Form - Custom handling for checkbox
    const addKidForm = document.querySelector('#addKidModal form');
    if (addKidForm) {
        addKidForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(addKidForm);
            // Ensure checkbox state is sent correctly
            const checkbox = document.getElementById('use_random_pin');
            formData.set('use_random_pin', checkbox.checked ? 'true' : 'false');
            
            try {
                const response = await fetch(addKidForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    document.getElementById('addKidModal').classList.remove('active');
                    addKidForm.reset();
                    location.reload();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error adding kid:', error);
                showMessage('An error occurred. Please try again.', 'error');
            }
        });
    }
    
    // Adjust Coins Forms
    document.querySelectorAll('[id^="adjustCoinsModal"]').forEach(modal => {
        const form = modal.querySelector('form');
        setupAjaxForm(form, {
            closeModal: modal.id,
            onSuccess: (data) => {
                // Update coin balance in UI
                if (data.kid_id) {
                    const coinBadge = document.querySelector(`.kid-item [data-kid-id="${data.kid_id}"] .coin-badge`);
                    if (coinBadge) {
                        coinBadge.textContent = `${data.new_balance} Coins`;
                    }
                }
                location.reload();
            }
        });
    });
    
    // Reset PIN Forms
    document.querySelectorAll('form[action*="reset-pin"]').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const kidId = form.getAttribute('data-kid-id');
            const checkbox = document.getElementById('use_random_pin_' + kidId);
            formData.set('use_random_pin', checkbox.checked ? 'true' : 'false');
            
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    const modalId = 'resetPinModal' + kidId;
                    document.getElementById(modalId).classList.remove('active');
                    form.reset();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error resetting PIN:', error);
                showMessage('An error occurred. Please try again.', 'error');
            }
        });
    });
    
    // Chore Approval/Rejection Forms (including adjust & approve and reject modals)
    document.querySelectorAll('form[action*="confirm-chore"], form[action*="reject-chore"]').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const assignmentId = form.getAttribute('data-assignment-id');
            const assignment = form.closest('.assignment-item');
            
            await submitForm(form, {
                onSuccess: (data) => {
                    // Close modal if this was from a modal form
                    if (assignmentId) {
                        // Check for adjust & approve modal
                        let modalId = 'adjustApproveModal' + assignmentId;
                        let modal = document.getElementById(modalId);
                        if (modal && modal.classList.contains('active')) {
                            modal.classList.remove('active');
                        }
                        
                        // Check for reject modal
                        modalId = 'rejectModal' + assignmentId;
                        modal = document.getElementById(modalId);
                        if (modal && modal.classList.contains('active')) {
                            modal.classList.remove('active');
                        }
                    }
                    
                    // Remove the assignment card if it was cancelled or approved
                    // (For redo, it stays in pending so the page will reload to show updated value)
                    const isCancelAction = form.querySelector('[name="reject_action"][value="cancel"]');
                    const isConfirmChore = form.action.includes('confirm-chore');
                    
                    if (assignment && (isCancelAction || isConfirmChore)) {
                        removeElement(assignment.closest('.col-12, .col-md-6'));
                    } else if (form.action.includes('reject-chore')) {
                        // For redo action, reload to show updated chore value
                        location.reload();
                    }
                    
                    // Update kid coin balance if provided
                    if (data.kid_id && data.new_balance !== undefined) {
                        const coinBadge = document.querySelector(`.kid-item [data-kid-id="${data.kid_id}"] .coin-badge`);
                        if (coinBadge) {
                            coinBadge.textContent = `${data.new_balance} Coins`;
                        }
                    }
                }
            });
        });
    });
    
    // Purchase Fulfillment/Cancellation Forms
    document.querySelectorAll('form[action*="fulfill-purchase"], form[action*="cancel-purchase"]').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const purchaseItem = form.closest('.assignment-item');
            await submitForm(form, {
                onSuccess: (data) => {
                    // Remove the purchase card
                    if (purchaseItem) {
                        removeElement(purchaseItem.closest('.col-12, .col-md-6'));
                    }
                    
                    // Update kid coin balance if refunded
                    if (data.kid_id && data.new_balance !== undefined) {
                        const coinBadge = document.querySelector(`.kid-item [data-kid-id="${data.kid_id}"] .coin-badge`);
                        if (coinBadge) {
                            coinBadge.textContent = `${data.new_balance} Coins`;
                        }
                    }
                }
            });
        });
    });
});
</script>
{% endblock %}
