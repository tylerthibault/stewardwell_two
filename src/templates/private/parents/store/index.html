{% extends "bases/private.html" %}

{% block title %}Manage Store - Stewardwell{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Manage Store</h1>
        <p>Rewards kids can purchase with coins</p>
    </div>

    {% include 'private/parents/components/navbar.html' %}

    <!-- Tabs (Desktop) -->
    <ul class="my-tabs">
        <li class="my-tab-item">
            <a href="#setup-tab" class="my-tab-link active" data-my-target="#setup-tab">Setup Items</a>
        </li>
        <li class="my-tab-item">
            <a href="#pending-tab" class="my-tab-link" data-my-target="#pending-tab">Pending Purchases ({{ pending_purchases|length }})</a>
        </li>
        <li class="my-tab-item">
            <a href="#fulfilled-tab" class="my-tab-link" data-my-target="#fulfilled-tab">Fulfilled Purchases</a>
        </li>
    </ul>

    <!-- Dropdown (Mobile) -->
    <div class="my-tabs-dropdown">
        <select>
            <option value="#setup-tab">Setup Items</option>
            <option value="#pending-tab">Pending Purchases ({{ pending_purchases|length }})</option>
            <option value="#fulfilled-tab">Fulfilled Purchases</option>
        </select>
    </div>

    <div class="my-tab-content">
        <!-- Setup Items Tab -->
        <div id="setup-tab" class="my-tab-pane active">
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Store Items</h2>
                <button onclick="toggleModal('addStoreItemModal')">+ Add Item</button>
            </div>
            <div class="card-body">
                {% if store_items %}
                <!-- Tag Filter -->
                <div id="tagFilterSection" style="margin-bottom: var(--space-lg); display: none;">
                    <div style="display: flex; align-items: center; gap: var(--space-sm); flex-wrap: wrap;">
                        <strong style="color: var(--text-primary);">Filter by tag:</strong>
                        <button class="tag-filter-btn active" data-tag="all" onclick="filterByTag('all')"
                            style="padding: 0.375rem 0.75rem; background: var(--accent-primary); color: white; border: var(--border-sm) solid var(--accent-dark); font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 0.8125rem; box-shadow: var(--shadow-sm) var(--shadow-sm) 0 var(--accent-dark); transition: all 0.2s;">
                            All
                        </button>
                        <div id="tagFilters" style="display: flex; gap: var(--space-sm); flex-wrap: wrap;"></div>
                    </div>
                </div>
                <div class="row g-3">
                    {% for item in store_items %}
                    <div class="col-12 col-md-6 col-lg-4">
                        {% include 'private/parents/store/components/cards.html' %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state text-center">
                    <p style="font-size: 1.1rem; color: var(--text-muted, #666);">No store items created yet</p>
                    <button class="btn-primary" onclick="toggleModal('addStoreItemModal')" style="margin-top: 1.5rem;">
                        + Add First Item
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        </div>

        <!-- Pending Purchases Tab -->
        <div id="pending-tab" class="my-tab-pane">
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Pending Purchase Requests</h2>
            </div>
            <div class="card-body">
                {% if pending_purchases %}
                    <div class="row g-3">
                        {% for purchase in pending_purchases %}
                        <div class="col-12 col-md-6 col-lg-4">
                        <div class="assignment-item">
                            <div class="assignment-info">
                                <strong>{{ purchase.kid.name }}</strong> wants to purchase 
                                <strong>{{ purchase.item.name }}</strong>
                                {% if purchase.item.description %}
                                    <p style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">{{ purchase.item.description }}</p>
                                {% endif %}
                                <span class="timestamp">{{ purchase.purchased_at.strftime('%Y-%m-%d %H:%M') if purchase.purchased_at else 'Just now' }}</span>
                                <div class="purchase-cost">{{ purchase.coin_cost }} coins</div>
                            </div>
                            <div class="assignment-actions">
                                <form method="POST" action="{{ url_for('parent.fulfill_purchase', purchase_id=purchase.id) }}" class="inline-form">
                                    <button type="submit" class="btn-success">âœ“ Fulfill</button>
                                </form>
                                <form method="POST" action="{{ url_for('parent.cancel_purchase', purchase_id=purchase.id) }}" class="inline-form">
                                    <button type="submit" class="btn-danger">âœ— Cancel & Refund</button>
                                </form>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No pending purchases</p>
                {% endif %}
            </div>
        </div>
        </div>

        <!-- Fulfilled Purchases Tab -->
        <div id="fulfilled-tab" class="my-tab-pane">
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h2>Fulfilled Purchase History</h2>
            </div>
            <div class="card-body">
                {% if fulfilled_purchases %}
                    <div class="row g-3">
                        {% for purchase in fulfilled_purchases %}
                        <div class="col-12 col-md-6 col-lg-4">
                        <div class="assignment-item">
                            <div class="assignment-info">
                                <strong>{{ purchase.kid.name }}</strong> purchased 
                                <strong>{{ purchase.item.name }}</strong>
                                {% if purchase.item.description %}
                                    <p style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">{{ purchase.item.description }}</p>
                                {% endif %}
                                <span class="timestamp">Fulfilled: {{ purchase.fulfilled_at.strftime('%Y-%m-%d %H:%M') if purchase.fulfilled_at else 'N/A' }}</span>
                                <div class="purchase-cost">{{ purchase.coin_cost }} coins</div>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No fulfilled purchases yet</p>
                {% endif %}
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Add Store Item Modal -->
<div id="addStoreItemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Store Item</h3>
            <span class="close" onclick="toggleModal('addStoreItemModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('parent.add_store_item') }}">
            <div class="form-group mb-3">
                <label for="item_name">Item Name</label>
                <input type="text" id="item_name" name="name" required placeholder="e.g., Extra TV time, Ice cream">
            </div>
            <div class="form-group mb-3">
                <label for="item_description">Description (optional)</label>
                <textarea id="item_description" name="description" rows="3"
                    placeholder="Describe the reward..."></textarea>
                <small class="help-text">Add details about this reward</small>
            </div>
            <div class="form-group mb-3">
                <label for="item_tags">Tags (Optional)</label>
                <input type="text" id="item_tags" name="tags" placeholder="e.g., treats, screentime, special">
                <small class="help-text">Separate multiple tags with commas</small>
            </div>
            <div class="form-group mb-3">
                <label for="item_coin_cost">Coin Cost</label>
                <input type="number" id="item_coin_cost" name="coin_cost" min="0" value="50" required>
            </div>
            <div class="modal-footer d-flex flex-wrap gap-2 justify-content-end">
                <button type="button" class="btn-secondary" onclick="toggleModal('addStoreItemModal')">Cancel</button>
                <button type="submit" class="btn-primary">Add Item</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Store Item Modal -->
<div id="editStoreItemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Store Item</h3>
            <span class="close" onclick="toggleModal('editStoreItemModal')">&times;</span>
        </div>
        <form id="editStoreItemForm" method="POST">
            <div class="form-group mb-3">
                <label for="edit_item_name">Item Name</label>
                <input type="text" id="edit_item_name" name="name" required placeholder="e.g., Extra TV time, Ice cream">
            </div>
            <div class="form-group mb-3">
                <label for="edit_item_description">Description (optional)</label>
                <textarea id="edit_item_description" name="description" rows="3"
                    placeholder="Describe the reward..."></textarea>
                <small class="help-text">Add details about this reward</small>
            </div>
            <div class="form-group mb-3">
                <label for="edit_item_tags">Tags (Optional)</label>
                <input type="text" id="edit_item_tags" name="tags" placeholder="e.g., treats, screentime, special">
                <small class="help-text">Separate multiple tags with commas</small>
            </div>
            <div class="form-group mb-3">
                <label for="edit_item_coin_cost">Coin Cost</label>
                <input type="number" id="edit_item_coin_cost" name="coin_cost" min="0" required>
            </div>
            <div class="form-group mb-3">
                <label style="display: flex; align-items: center; gap: var(--space-sm); text-transform: none; cursor: pointer;">
                    <input type="checkbox" id="edit_is_available" name="is_available" style="width: auto; cursor: pointer;">
                    <span>Available (visible to kids)</span>
                </label>
                <small class="help-text">Uncheck to hide this item from kids</small>
            </div>
            <div class="modal-footer d-flex flex-wrap gap-2 justify-content-end">
                <button type="button" class="btn-secondary" onclick="toggleModal('editStoreItemModal')">Cancel</button>
                <button type="submit" class="btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/api.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/tabs.js') }}"></script>
<script>
    function toggleModal(modalId) {
        document.getElementById(modalId).classList.toggle('active');
    }

    // Tag filtering system for store items
    document.addEventListener('DOMContentLoaded', function () {
        // Setup AJAX for add store item form
        setupAjaxForm('#addStoreItemModal form', {
            closeModal: 'addStoreItemModal',
            onSuccess: () => {
                location.reload();
            }
        });

        // Setup AJAX for edit store item form
        setupAjaxForm('#editStoreItemForm', {
            closeModal: 'editStoreItemModal',
            onSuccess: () => {
                location.reload();
            }
        });

        // Handle toggle store item forms
        document.querySelectorAll('form[action*="toggle-store-item"]').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                await submitForm(form, {
                    onSuccess: (data) => {
                        // Update the button text
                        const button = form.querySelector('button[type="submit"]');
                        if (button) {
                            button.textContent = data.is_available ? 'âœ“ Available' : 'ðŸ‘ï¸ Hidden';
                            button.className = `status-badge ${data.is_available ? 'active' : 'inactive'}`;
                            button.title = `Click to ${data.is_available ? 'hide' : 'show'}`;
                        }
                    }
                });
            });
        });

        // Handle view details buttons
        document.querySelectorAll('.view-item-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const itemId = this.dataset.itemId;
                toggleModal('itemDetailsModal-' + itemId);
            });
        });

        // Handle edit buttons
        document.querySelectorAll('.edit-item-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const itemId = this.dataset.itemId;
                const name = this.dataset.itemName;
                const description = this.dataset.itemDescription;
                const tags = this.dataset.itemTags;
                const cost = this.dataset.itemCost;
                const isAvailable = this.dataset.itemAvailable === 'true';

                // Set form action
                document.getElementById('editStoreItemForm').action = '/parent/edit-store-item/' + itemId;

                // Populate form fields
                document.getElementById('edit_item_name').value = name;
                document.getElementById('edit_item_description').value = description || '';
                document.getElementById('edit_item_tags').value = tags || '';
                document.getElementById('edit_item_coin_cost').value = cost;
                document.getElementById('edit_is_available').checked = isAvailable;

                // Open modal
                toggleModal('editStoreItemModal');
            });
        });

        // Handle delete buttons
        document.querySelectorAll('.delete-item-btn').forEach(function (btn) {
            btn.addEventListener('click', async function () {
                const itemId = this.dataset.itemId;
                const itemName = this.dataset.itemName;
                if (confirm('Delete ' + itemName + '? This cannot be undone.')) {
                    const form = document.getElementById('delete-item-form-' + itemId);
                    await submitForm(form, {
                        onSuccess: () => {
                            // Remove the item card
                            const itemCard = form.closest('.col-12, .col-md-6');
                            if (itemCard) {
                                removeElement(itemCard);
                            }
                        }
                    });
                }
            });
        });

        const allTags = new Set();

        // Collect all unique tags from store items
        document.querySelectorAll('.store-item').forEach(function (item) {
            const tags = item.dataset.itemTags;
            if (tags) {
                tags.split(',').forEach(function (tag) {
                    const trimmed = tag.trim();
                    if (trimmed) {
                        allTags.add(trimmed);
                    }
                });
            }
        });

        // Populate filter buttons if tags exist
        if (allTags.size > 0) {
            const tagFilters = document.getElementById('tagFilters');
            allTags.forEach(function (tag) {
                const btn = document.createElement('button');
                btn.className = 'tag-filter-btn';
                btn.dataset.tag = tag;
                btn.textContent = '#' + tag;
                btn.style.cssText = 'padding: 0.375rem 0.75rem; background: var(--bg-light); color: var(--text-primary); border: var(--border-sm) solid var(--accent-dark); font-weight: 700; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease;';
                btn.onclick = function () { filterByTag(tag); };
                tagFilters.appendChild(btn);
            });

            // Show filter section
            document.getElementById('tagFilterSection').style.display = 'block';
        }

        // Filter function
        window.filterByTag = function (tag) {
            document.querySelectorAll('.store-item').forEach(function (item) {
                const tags = item.dataset.itemTags;
                const col = item.closest('.col-12, .col-md-6');

                if (tag === 'all') {
                    col.style.display = 'block';
                } else if (tags && tags.split(',').some(function (t) { return t.trim() === tag; })) {
                    col.style.display = 'block';
                } else {
                    col.style.display = 'none';
                }
            });

            // Update active button styling
            document.querySelectorAll('.tag-filter-btn').forEach(function (btn) {
                if (btn.dataset.tag === tag) {
                    btn.classList.add('active');
                    btn.style.background = 'var(--accent-primary)';
                    btn.style.color = 'white';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'var(--bg-light)';
                    btn.style.color = 'var(--text-primary)';
                }
            });
        };

        // Purchase Fulfillment/Cancellation Forms
        document.querySelectorAll('form[action*="fulfill-purchase"], form[action*="cancel-purchase"]').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const purchaseItem = form.closest('.assignment-item');
                await submitForm(form, {
                    onSuccess: (data) => {
                        // Reload to update counts and lists
                        location.reload();
                    }
                });
            });
        });
    });
</script>
{% endblock %}